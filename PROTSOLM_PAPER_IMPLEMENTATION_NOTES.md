# ProtSolM: Paper-Derived Implementation & Integration Notes

_Last updated: 2025-07-16_

---

## 1. **Model Overview and Architecture**
- **ProtSolM** is a multi-modal deep learning model for protein solubility prediction.
- Integrates three information sources:
  1. **Sequence** (AA-level, ESM2 embeddings)
  2. **Structure** (kNN graph of protein backbone, processed by EGNN)
  3. **Physicochemical features** (42 handcrafted, DSSP/mkdssp-derived)
- Model pipeline:
  - **Pre-training:** ESM2 + EGNN layers on wild-type proteins (denoising task)
  - **Fine-tuning:** Attention pooling + concatenation with normalized protein-level features; fully connected layers for binary solubility prediction

---

## 2. **Feature Extraction Pipeline**
- **All features must be generated and processed identically for both training and inference.**
- **Protein-level features** (total = 42):
  - Fraction of charged AAs: C, D, E, R, H
  - Fraction of turn-forming residues: N, G, P
  - GRAVY index (hydropathy)
  - Secondary structure fractions (DSSP 3-state, 9-state)
  - Exposed residue fractions (RSA bins from 5% to 100%)
  - Hydrogen bond count/density (MDTraj)
  - Structure confidence (mean pLDDT, from ESMFold)
- **Sequence features:** ESM2 embeddings (handled inside model)
- **Structure features:** kNN graph, edge features (distances, local positions, sequence encoding)
- **Critical:**
  - Use **mkdssp** for secondary structure/solvent accessibility
  - Use the same `get_feature.py` script and mkdssp version as in training
  - Columns and order in feature CSV must match training exactly

---

## 3. **Data and Preprocessing**
- **Training data:** PDBSol (PDBS OL) — >60,000 proteins, processed as follows:
  - Remove non-protein entities (virus, DNA/RNA, etc.)

---

## 4. **End-to-End Prediction Workflow for Custom Proteins (PeptideFrontEnd/GA Integration)**

This is the canonical, robust workflow for running ProtSolM predictions on custom protein sets generated by PeptideFrontEnd or the Genetic Algorithm system. It assumes your input FASTA is in the PeptideFrontEnd directory, and that all paths are relative to the ProtSolM project root.

### **Step 1: Convert FASTA to CSV**
Convert your custom FASTA (e.g., `random_proteins_combined.fasta`) to a ProtSolM-compatible CSV.

```bash
python fasta_to_csv.py ../PeptideFrontEnd/random_proteins_combined.fasta data/PDBSol/random_proteins_combined.csv
```
- Output: `data/PDBSol/random_proteins_combined.csv` with columns `id,aa_seq,label`

### **Step 2: Prepare Raw PDBs**
Ensure your raw PDBs (matching the protein IDs in your FASTA/CSV) are in:
```
data/PDBSol/esmfold_pdb/
```
- Each file should be named `{id}.pdb` (where `{id}` matches the FASTA/CSV).

### **Step 3: Format PDBs for DSSP**
This will overwrite any existing files in `pdb_final` with newly formatted versions.

```bash
cd data/PDBSol/esmfold_pdb
bash ../../../format_pdb.sh
cd ../../../..
```
- Output: Formatted PDBs in `data/PDBSol/esmfold_pdb/pdb_final/`

### **Step 4: Extract Features**
Run the feature extraction script using the formatted PDBs.

```bash
python get_feature.py \
  --pdb_dir data/PDBSol/esmfold_pdb/pdb_final \
  --out_file data/PDBSol/random_proteins_combined_feature.csv
```
- Output: `data/PDBSol/random_proteins_combined_feature.csv` (canonical 42 features, correct order)

### **Step 5: Run Prediction/Evaluation**
Run ProtSolM’s evaluation using your generated files.

```bash
python eval.py \
  --supv_dataset data/PDBSol \
  --test_file data/PDBSol/random_proteins_combined.csv \
  --test_result_dir results/protsolm_pred/ \
  --feature_file data/PDBSol/random_proteins_combined_feature.csv \
  --feature_name "aa_composition" "gravy" "ss_composition" "hygrogen_bonds" "exposed_res_fraction" "pLDDT" \
  --use_plddt_penalty \
  --gnn_hidden_dim 512 \
  --gnn_model_path model/protssn_k20_h512.pt \
  --pooling_method attention1d \
  --model_dir ckpt \
  --model_name feature512_norm_pp_attention1d_k20_h512_lr5e-4.pt \
  --num_labels 2 \
  --c_alpha_max_neighbors 20 \
  --batch_token_num 16000
```
- Output: Prediction results in `results/protsolm_pred/`

### **Summary Table**

| Step | Script/Command | Input | Output |
|------|----------------|-------|--------|
| 1 | `fasta_to_csv.py` | `../PeptideFrontEnd/random_proteins_combined.fasta` | `data/PDBSol/random_proteins_combined.csv` |
| 2 | Place PDBs | `{id}.pdb` files | `data/PDBSol/esmfold_pdb/` |
| 3 | `format_pdb.sh` | Raw PDBs | `data/PDBSol/esmfold_pdb/pdb_final/` |
| 4 | `get_feature.py` | Formatted PDBs | `data/PDBSol/random_proteins_combined_feature.csv` |
| 5 | `eval.py` | All above | `results/protsolm_pred/` |

---

**This workflow is benchmark-ready and fully automatable.**
- All paths and commands are suitable for integration with PeptideFrontEnd and the Genetic Algorithm system.
- Adjust filenames as needed for other datasets.
  - Remove His-tags, redundancy (MMS EQS 2, 25% identity), extreme lengths
  - Exclude transmembrane proteins (DeepTMHMM)
  - Balance by length/class
- **Test data:** External benchmarks (ESOL-agg, NESG-SoluProt, NESG-DSResSol), deduplicated at 25% identity
- **All structures predicted with ESMFold**
- **All features extracted with mkdssp, MDTraj, biotite, etc.**

---

## 4. **Integration with PeptideFrontEnd & GA**
- **Workflow:**
  1. Generate/collect PDBs for all candidate sequences
  2. Run mkdssp to extract DSSP features
  3. Run `get_feature.py` to produce feature CSV (42 features, canonical order)
  4. Use ProtSolM wrapper to predict solubility (outputs standardized CSV)
  5. PeptideFrontEnd/GA calls ProtSolM as a subprocess, parses CSV, uses score in fitness evaluation
- **Fitness function:**
  - Use ProtSolM solubility score (alongside bioactive ratio, cleavage success, etc.)
  - Ensure feature file for each batch matches training format
- **Automation:**
  - Automate all steps above for batch processing in GA
  - Standardize input/output formats for benchmarking and integration

---

## 5. **Model Training & Evaluation Protocols**
- **Pre-training:** Denoising task with ESM2 + EGNN
- **Fine-tuning:**
  - AdamW optimizer, lr=0.0005, weight decay=0.01, dropout=0.1
  - Dynamic batching (up to 16,000 tokens per batch)
  - 30 epochs max, patience=5 (early stopping on validation ACC)
- **Evaluation:**
  - Metrics: ACC, precision, recall, AUC, MCC
  - Binary threshold: 0.5
  - Compare to baselines: DeepSoluE, ccSOL omics, SoluProt, SKADE, Camsol, NetSolP, DSResSOL, ESM2, ProtBert, ProtT5, Ankh

---

## 6. **Ablation Study Insights**
- Removing any of: pLDDT penalty, attention pooling, or physicochemical features reduces accuracy
- **All three modalities (sequence, structure, physicochemical) are critical for SOTA performance**

---

## 7. **Best Practices & Recommendations**
- **Never change the feature extraction pipeline** between training and inference
- **Document and enforce canonical feature order** in all scripts
- **Automate and standardize the pipeline** for GA/PeptideFrontEnd integration
- **Keep mkdssp and all dependencies version-matched** to training
- **Keep all wrappers and output CSVs standardized** for benchmarking

---

## 8. **References**
- Paper: Tan et al., 2024, "ProtSolM: Protein Solubility Prediction with Multi-modal Features" (arXiv:2406.19744)
- Code: https://github.com/tyang816/ProtSolM
- ESM2: Lin et al., Science 2023
- EGNN: Satorras et al., ICML 2021

---

**This document summarizes all implementation-critical information from the Tan2024_ProtSolM paper for current and future development, integration, and troubleshooting. Update as needed when the pipeline or requirements change.**
